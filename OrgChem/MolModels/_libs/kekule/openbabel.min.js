Kekule.LOCAL_RES=true;Kekule.Localization.setCurrModule("extra.openbabel");Kekule.Localization.addResource("en","ErrorMsg",{OpenBabel:{CHEM_NODE_TYPE_NOT_SUITABLE:"Unsuitable node type",CHEM_CONNECTOR_TYPE_NOT_SUITABLE:"Unsuitable connector type",ONLY_STR_INPUT_DATA_ALLOWED:"Input data must be text",ONLY_STR_OUTPUT_DATA_ALLOWED:"Output data must be text",FAIL_TO_GENERATE_3D_STRUCTURE:"Fail to generate 3D structure coordinates"}});(function(){var a=Kekule.EmscriptenUtils;Kekule.OpenBabel={SCRIPT_FILE:"openbabel.js",BondOrder:{SINGLE:1,DOUBLE:2,TRIPLE:3,EXPLICIT_AROMATIC:5}};Kekule.OpenBabel.getObPath=function(){var c=Kekule.scriptSrcInfo.useMinFile;var b=c?"":"_extras/OpenBabel/";b=Kekule.scriptSrcInfo.path+b;return b};Kekule.OpenBabel.getObScriptUrl=function(){var b=Kekule.OpenBabel.getObPath()+Kekule.OpenBabel.SCRIPT_FILE;var c=Kekule.scriptSrcInfo.useMinFile;if(!c){b+=".dev"}return b};Kekule.OpenBabel.loadObScript=function(c,d){if(!c){c=document}if(!Kekule.OpenBabel._obScriptLoaded){var b=Kekule.OpenBabel.getObScriptUrl();Kekule.ScriptFileUtils.appendScriptFile(c,b,d);Kekule.OpenBabel._obScriptLoaded=true}else{if(d){d()}}};Kekule.OpenBabel.AdaptUtils={DEF_ATOM_ID_PREFIX:"A",DEF_BOND_ID_PREFIX:"B",DEF_MOL_ID_PREFIX:"M",wrapCFuncs:function(){if(!Kekule.OpenBabel._funcInited){var b={};Object.extend(Kekule.OpenBabel,b);Kekule.OpenBabel._funcInited=true}},isAvailable:function(){return typeof(a.getClassCtor("ObBaseHelper"))!=="undefined"},obObjToKekule:function(c){var b=Kekule.OpenBabel.AdaptUtils;var d=Kekule.ObjUtils.getPrototypeOf(c).constructor.name;var e=(d==="OBReaction")?b.obReactionToKekule:(d==="OBMol")?b.obMolToKekule:(d==="OBAtom")?b.obAtomToKekule:(d==="OBBond")?b.obBondToKekule:b.obBaseToKekule;return e(c)},kObjToOB:function(d){var b=Kekule.OpenBabel.AdaptUtils;var c=(d instanceof Kekule.Reaction)?b.kReactionToOB:(d instanceof Kekule.StructureFragment)?b.kMolToOB:(d instanceof Kekule.ChemStructureNode)?b.kChemNodeToOB:(d instanceof Kekule.ChemStructureConnector)?b.kBondToOB:b.kChemNodeToOB;return c(d)},kIdToOB:function(c){var b=parseInt(c,10);if(b){return b}else{return null}},obBondOrderToKekule:function(b){if(b<=3){return b}else{if(b===Kekule.OpenBabel.BondOrder.EXPLICIT_AROMATIC){return Kekule.BondOrder.EXPLICIT_AROMATIC}else{return Kekule.BondOrder.OTHER}}},kBondOrderToOB:function(b){if(b<=3){return b}else{if(b===Kekule.BondOrder.EXPLICIT_AROMATIC){return Kekule.OpenBabel.BondOrder.EXPLICIT_AROMATIC}else{return 0}}},obBaseToKekule:function(l,c){var m=c||new Kekule.ChemObject();var e=new (a.getClassCtor("ObBaseHelper"))(l);var h=e.getTitle();if(h&&m.setName){m.setName(h)}var b=e.getDataSize();if(b){var d=m.getInfo(true);for(var g=0;g<b;++g){var f=e.getDataAt(g);if(f){var k=f.GetAttribute();var j=f.GetValue();if(k&&j){d[k]=j}}}}return m},kChemObjToOB:function(b,k){var m=k||new (a.getClassCtor("OBBase"))();if(b.getName&&m.SetTitle){m.SetTitle(b.getName())}var c=b.getInfo();if(c){var j=Kekule.ObjUtils.getOwnedFieldNames(c);for(var f=0,d=j.length;f<d;++f){var h=j[f];var g=c[h];if(h&&g){var e=new (a.getClassCtor("OBPairData"))();e.SetAttribute(""+h);e.SetValue(""+g);m.SetData(e)}}}},obAtomToKekule:function(g,f,e){var h=g.GetAtomicNum();var d=h?Kekule.Atom:Kekule.SubGroup;if(f&&(!(f instanceof d))){Kekule.Error(Kekule.$L("ErrorMsg.OpenBabel.CHEM_NODE_TYPE_NOT_SUITABLE"))}var b=f||new d();Kekule.OpenBabel.AdaptUtils.obBaseToKekule(g,b);var c;c=g.GetId();if(Kekule.ObjUtils.notUnset(c)){b.setId(Kekule.OpenBabel.AdaptUtils.DEF_ATOM_ID_PREFIX+c)}c=g.GetFormalCharge();if(c){b.setCharge(c)}c=g.GetSpinMultiplicity();if(c){b.setRadical(c)}c={x:g.GetX(),y:g.GetY()};if(e===Kekule.CoordMode.COORD3D){c.z=g.GetZ()}if(b.setAbsCoordOfMode){b.setAbsCoordOfMode(c,e)}else{b.setCoordOfMode(c,e)}if(b instanceof Kekule.Atom){if(h){b.setAtomicNumber(h)}c=g.GetIsotope();if(c){b.setMassNumber(c)}c=g.GetHyb();if(c){b.setHybridizationType(c)}}return b},kChemNodeToOB:function(h,j,e){var b=j||new (a.getClassCtor("OBAtom"))();var c;c=h.getId();c=Kekule.OpenBabel.AdaptUtils.kIdToOB(c);if(Kekule.ObjUtils.notUnset(c)){b.SetId(c)}c=h.getCharge();if(c){if(parseInt(c,10)===parseFloat(c)){b.SetFormalCharge(c)}else{var d=parseInt(c,10);var g=c-d;b.SetFormalCharge(d);b.SetPartialCharge(g)}}c=h.getRadical();if(c){b.SetSpinMultiplicity(c)}c=h.getAbsCoordOfMode?h.getAbsCoordOfMode(e):h.getCoordOfMode(e);b.SetVector(c.x||0,c.y||0,c.z||0);if(h instanceof Kekule.Atom){b.SetAtomicNum(h.getAtomicNumber());c=h.getMassNumber();if(c){b.SetIsotope(c)}c=h.getHybridizationType();if(c){b.SetHyb(c)}}else{b.SetAtomicNum(0)}return b},obBondToKekule:function(h,k,c){var m=k||new Kekule.Bond();Kekule.OpenBabel.AdaptUtils.obBaseToKekule(h,m);var j;j=h.GetId();if(Kekule.ObjUtils.notUnset(j)){m.setId(Kekule.OpenBabel.AdaptUtils.DEF_BOND_ID_PREFIX+j)}j=h.GetBondOrder();m.setBondOrder(Kekule.OpenBabel.AdaptUtils.obBondOrderToKekule(j));var d=Kekule.BondStereo;j=h.IsWedge()?d.UP:h.IsHash()?d.DOWN:h.IsWedgeOrHash()?d.UP_OR_DOWN:h.IsCisOrTrans()?d.CIS_OR_TRANS:h.IsDoubleBondGeometry()?d.E_Z_BY_COORDINATES:d.NONE;m.setStereo(j);if(c){j=null;var f=[h.GetBeginAtom(),h.GetEndAtom()];for(var e=0,b=f.length;e<b;++e){var g=f[e];if(g){j=c.get(g.GetIdx());if(j){m.appendConnectedObj(j)}}}}return m},kBondToOB:function(k,h,d,b){var n=h||new (a.getClassCtor("OBBond"))();Kekule.OpenBabel.AdaptUtils.kChemObjToOB(k,n);var j;j=Kekule.OpenBabel.AdaptUtils.kIdToOB(k.getId());if(Kekule.ObjUtils.notUnset(j)){n.SetId(j)}j=k.getBondOrder();if(j){n.SetBondOrder(Kekule.OpenBabel.AdaptUtils.kBondOrderToOB(j));if(j===Kekule.BondOrder.EXPLICIT_AROMATIC){n.SetAromatic()}}n.UnsetHash();n.UnsetWedge();n.UnsetUp();n.UnsetDown();n.UnsetAromatic();var g=Kekule.BondStereo;j=k.getStereo();if(j===g.UP){n.SetWedge()}else{if(j===g.DOWN){n.SetHash()}else{if(j===g.UP_OR_DOWN){n.SetWedgeOrHash()}}}if(d){var m=0;for(var f=0,c=k.getConnectedObjCount();f<c;++f){var e=k.getConnectedObjAt(f);if(e&&(e instanceof Kekule.ChemStructureNode)){var j=d.get(e);if(j){if(m===0){n.SetBegin(j)}else{if(m===1){n.SetEnd(j)}}++m}if(m>1){break}}}}return n},obMolToKekule:function(b,h){var m=h||new Kekule.Molecule();Kekule.OpenBabel.AdaptUtils.obBaseToKekule(b,m);var d=b.Has3D()?Kekule.CoordMode.COORD3D:Kekule.CoordMode.COORD2D;m.clearNodes();m.clearConnectors();var e=new Kekule.MapEx(true);var j=b.NumAtoms();for(var g=0;g<j;++g){var f=b.GetAtom(g+1);if(f){var c=Kekule.OpenBabel.AdaptUtils.obAtomToKekule(f,null,d);if(c){m.appendNode(c);e.set(f.GetIdx(),c)}}}var j=b.NumBonds();for(var g=0;g<j;++g){var k=b.GetBond(g);if(k){var l=Kekule.OpenBabel.AdaptUtils.obBondToKekule(k,null,e);if(l){m.appendConnector(l)}}}e.finalize();e=null;return m},kMolToOB:function(j,b){var e=j.nodesHasCoord3D()?Kekule.CoordMode.COORD3D:Kekule.CoordMode.COORD2D;var n=b||new (a.getClassCtor("OBMol"))();if(b){n.Clear()}var f=new Kekule.MapEx(false);for(var h=0,d=j.getNodeCount();h<d;++h){var c=j.getNodeAt(h);if(c){var g=Kekule.OpenBabel.AdaptUtils.kChemNodeToOB(c,n.NewAtom(),e);if(g){f.set(c,g)}}}for(var h=0,d=j.getConnectorCount();h<d;++h){var m=j.getConnectorAt(h);if(m&&(m instanceof Kekule.Bond)){var k=Kekule.OpenBabel.AdaptUtils.kBondToOB(m,n.NewBond(),f,n)}}f.finalize();f=null;return n},obReactionToKekule:function(h,f){var b=f||new Kekule.Reaction();b.clearAll();Kekule.OpenBabel.AdaptUtils.obBaseToKekule(h,b);b.setDirection(h.IsReversible()?Kekule.ReactionDirection.BIDIRECTION:Kekule.ReactionDirection.FORWARD);for(var g=0,e=h.NumReactants();g<e;++g){var d=h.GetReactant(g);var c=Kekule.OpenBabel.AdaptUtils.obMolToKekule(d);b.appendReactant(c)}for(var g=0,e=h.NumProducts();g<e;++g){var d=h.GetProduct(g);var c=Kekule.OpenBabel.AdaptUtils.obMolToKekule(d);b.appendProduct(c)}return b},kReactionToOB:function(h,d){var k=d||new (a.getClassCtor("OBReaction"))();k.Clear();Kekule.OpenBabel.AdaptUtils.kChemObjToOB(h,k);var b=false;var j=h.getDirection();if(j===Kekule.ReactionDirection.BIDIRECTION){k.SetReversible(true)}else{if(j===Kekule.ReactionDirection.BACKWARD){b=true}}for(var f=0,e=h.getReactantCount();f<e;++f){var g=h.getReactantAt(f);if(g){var c=Kekule.OpenBabel.AdaptUtils.kMolToOB(g);if(b){k.AddProduct(c)}else{k.AddReactant(c)}}}for(var f=0,e=h.getProductCount();f<e;++f){var g=h.getProductAt(f);if(g){var c=Kekule.OpenBabel.AdaptUtils.kMolToOB(g);if(b){k.AddReactant(c)}else{k.AddProduct(c)}}}}}})();(function(){var b=Kekule.EmscriptenUtils;var a=Kekule.OpenBabel.AdaptUtils;Kekule.IO.OpenBabelReader=Class.create(Kekule.IO.ChemDataReader,{CLASS_NAME:"Kekule.IO.OpenBabelReader",initialize:function($super,c){$super()},finalize:function($super){$super()},getFormatTargetObClassName:function(c){var e=c.getTypeName();var d=(e.toLowerCase().indexOf("reaction")>=0);return d?"OBReaction":"OBMol"},doReadData:function(j,m,n){this._obConv=new (b.getClassCtor("ObConversionWrapper"))();try{var l=Kekule.IO.DataFormatsManager.getFormatInfo(n);var c=l.mimeType;var q=l.fileExts[0];var e=this._obConv.setInFormat(c,q);var g=this.getFormatTargetObClassName(e);try{var k=[];this._obConv.setInStr(j);var f=new (b.getClassCtor(g))();var o=this._obConv.readFromInput(f);while(o){if(f.NumAtoms&&(f.NumAtoms()>0)){kObj=a.obObjToKekule(f);k.push(kObj)}o=this._obConv.readFromInput(f)}var d=k.length;if(d<=0){return null}else{if(d===1){return k[0]}else{var p=new Kekule.ChemObjList();for(var h=0;h<d;++h){p.append(k[h])}return p}}}finally{if(f){f["delete"]();f=null}}}finally{if(this._obConv){this._obConv["delete"]();this._obConv=null}}}});Kekule.IO.OpenBabelWriter=Class.create(Kekule.IO.ChemDataWriter,{CLASS_NAME:"Kekule.IO.OpenBabelWriter",initialize:function($super,c){$super(c)},finalize:function($super){$super()},doWriteData:function(f,m,n){this._obConv=new (b.getClassCtor("ObConversionWrapper"))();try{var k=Kekule.IO.DataFormatsManager.getFormatInfo(n);var c=k.mimeType;var q=k.fileExts[0];this._obConv.setOutFormat(c,q);var h=Kekule.ChemStructureUtils.getChildStructureObjs(f,true);for(var g=0,e=h.length;g<e;++g){var j=h[g];if(j){var d=a.kObjToOB(j);if(d){try{var o=this._obConv.writeToOutput(d);if(!o){break}}finally{d["delete"]();d=null}}}}var p=this._obConv.getOutStr();return p}finally{if(this._obConv){this._obConv["delete"]()}}},isAllowedObj:function(c){var d=Kekule.IO.OpenBabelWriter.ALLOWED_CLASSES;return Kekule.ObjUtils.isInstanceOf(c,d)}});Kekule.IO.OpenBabelWriter.ALLOWED_CLASSES=[Kekule.StructureFragment,Kekule.Reaction,Kekule.ChemObjList,Kekule.ChemStructureObjectGroup,Kekule.ChemSpaceElement,Kekule.ChemSpace];Kekule.OpenBabel.IORegHelper=Class.create({listFormatInfo:function(m,h){var q=[];var c="\n";var f="--";var j;if(m==="in"){j=h.getSupportedInputFormatsStr(c)}else{j=h.getSupportedOutputFormatsStr(c)}var n=j.split(c);for(var k=0,g=n.length;k<g;++k){var p=n[k];var o=p.indexOf(f);if(o>0){var d=p.substring(0,o).trim();var e=h.getFormatInfoById(d);q.push(e)}}return q},registerByInfos:function(p,o){var n=Kekule.IO.DataFormatsManager;var k=[];for(var m=0,h=p.length;m<h;++m){var g=p[m];var d=g.id;var c=g.mimeType;var e=n.findFormatId(c);if(e){e=n.findFormatId(null,d)}if(!e){var f=n.register(d,c,d,Kekule.IO.ChemDataType.UNKNOWN,g.description,g.description,{specificationUrl:g.specificationURL});var e=f.id}var j=(o==="in")?Kekule.IO.ChemDataReaderManager.getReaderInfoByFormat(e):Kekule.IO.ChemDataWriterManager.getWriterInfoByFormat(e);if(!j){Kekule.ArrayUtils.pushUnique(k,e)}}if(k.length){if(o==="in"){Kekule.IO.ChemDataReaderManager.register("openbabel",Kekule.IO.OpenBabelReader,k)}else{Kekule.IO.ChemDataWriterManager.register("openbabel",Kekule.IO.OpenBabelWriter,Kekule.IO.OpenBabelWriter.ALLOWED_CLASSES,k)}}},registerAll:function(){var c=new (b.getClassCtor("ObConversionWrapper"))();try{var d=this.listFormatInfo("in",c);this.registerByInfos(d,"in");var d=this.listFormatInfo("out",c);this.registerByInfos(d,"out")}finally{c["delete"]()}}});Kekule.IO.registerAllOpenBabelFormats=function(){if(Kekule.OpenBabel.AdaptUtils.isAvailable()){try{var c=new Kekule.OpenBabel.IORegHelper();c.registerAll()}finally{c=null}}};Kekule.IO.enableOpenBabelFormats=function(){if(!Kekule.OpenBabel.AdaptUtils.isAvailable()){Kekule.OpenBabel.loadObScript(document,function(){Kekule.IO.registerAllOpenBabelFormats()})}else{Kekule.IO.registerAllOpenBabelFormats()}};(function(){Kekule.X.domReady(function(){Kekule.IO.registerAllOpenBabelFormats()})})()})();(function(){var b=Kekule.EmscriptenUtils;var a=Kekule.OpenBabel.AdaptUtils;Kekule.OpenBabel.StructUtils={generate3DStructure:function(f,e){var g=new (b.getClassCtor("OB3DGenWrapper"))();try{var d=Kekule.IO.saveMimeData(f,"chemical/x-mdl-molfile");try{var c=g.generate3DStructureFromMolData(d,e||"");if(!c){Kekule.raise(Kekule.$L("ErrorMsg.OpenBabel.FAIL_TO_GENERATE_3D_STRUCTURE"))}else{var h=a.obObjToKekule(c)}c["delete"]()}finally{}}finally{g["delete"]()}return h}};if(Kekule.Calculator){Kekule.Calculator.ObStructure3DGenerator=Class.create(Kekule.Calculator.AbstractStructure3DGenerator,{CLASS_NAME:"Kekule.Calculator.ObStructure3DGenerator",getForceField:function(){return this.getOptions().forceField},createWorker:function($super){var c=$super();if(c){var d=Kekule.OpenBabel.getObScriptUrl();this.importWorkerScriptFile(d)}return c},getWorkerScriptFile:function(){return Kekule.OpenBabel.getObPath()+"workers/kekule.worker.obStructure3DGenerator.js"},doReactWorkerMessage:function(d,g){if(d.type==="output3D"){var f=d.molData;if(f){var c=Kekule.IO.loadMimeData(f,"chemical/x-mdl-molfile");this.setGeneratedMol(c);this.done()}}},workerStartCalc:function(e){var d=this.getSourceMol();var c=Kekule.IO.saveMimeData(d,"chemical/x-mdl-molfile");this.postWorkerMessage({type:"gen3D",molData:c,forceField:this.getForceField()})},executeSync:function(d){if(Kekule.OpenBabel&&document){var c=this;Kekule.OpenBabel.loadObScript(document,function(){var f;try{var g=Kekule.OpenBabel.StructUtils.generate3DStructure(c.getSourceMol(),c.getForceField());c.setGeneratedMol(g)}catch(h){f=h}if(d){d(f)}})}else{Kekule.error(Kekule.$L("ErrorMsg.MODULE_NOT_LOADED").format("OpenBabel"))}return false}});Kekule.Calculator.ServiceManager.register(Kekule.Calculator.Services.GEN3D,Kekule.Calculator.ObStructure3DGenerator)}})();